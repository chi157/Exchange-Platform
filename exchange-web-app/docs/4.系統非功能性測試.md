系統非功能性測試計畫（System Non-Functional Test Plan）

更新日期：2025-12-12

前言與範圍

- 本計畫針對目前已完成之功能（UC-01~UC-08）進行安全性、恢復力、壓力與效能測試的完整設計，並將測試案例直接關聯專案中的程式模組、API 端點與資料庫查詢/設定。
- 涉及檔案族群：
  - 後端：`src/main/java/...` 的 Controller/Service/Repository（具體端點如 `/ui/*`, `/api/*`）。
  - 前端：`src/main/resources/templates/*.html`（例如 `home.html`）、`static/*`。
  - 設定：`application.yml`、`application-test.yml`（位於 `target/test-classes/application-test.yml`）。
  - SQL：`exchange-web-app/*.sql`（`fix-chatroom-status.sql`, `fix-shipments.sql`, `fix-swaps-m5.sql`, `add-verification-code-columns.sql` 等）。
  - 外掛/外部：`utils/etracking/etracking.py`、`GOOGLE_OAUTH_SETUP.md`、Email 通知相關檔案與模板。

一、測試總覽與代碼關聯性（Code Correlation）

- 安全性（Security）：
  - 路由與授權：`Auth`/`Security` filter、保護之 `/ui/profile`, `/ui/my-listings`, `/ui/proposals/mine`, `/ui/chat`；任何 `/admin` 或管理介面路由（若存在）。
  - 表單與輸入過濾：JSP/Thymeleaf 模板中的 `th:text`/`th:utext` 使用情形；聊天室訊息、刊登描述、提案留言等輸入欄位。
  - API 端點：`/api/auth/login`, `/api/listings`, `/api/proposals`, `/api/chat/{roomId}/messages`, `/api/shipment/{id}/update`。
- 恢復（Recovery）：
  - 交易與狀態機：提案/聊天/出貨/追蹤/送達的 Service 與 Repository；資料一致性與事務邊界。
  - 外部服務：SMTP 寄送與重試、Google OAuth 回調、`etracking.py` 查詢物流超時與錯誤碼映射。
- 壓力（Stress）：
  - 認證與聊天：`/api/auth/login` 并發、`/api/chat/*` 高頻訊息；郵件批次寄送。
  - 搜尋/列表：`/api/listings` 多條件查詢與分頁。
- 效能（Performance）：
  - 首頁載入：`templates/home.html` 靜態資源載入與 TTFB；受 `application.yml` 伺服器設定影響。
  - 搜尋 SQL：Repository 層查詢（索引命中、過濾條件、排序白名單）。

二、風險評估（Risk Assessment）

- 路由授權空隙：未登入訪問 `/ui/*` 私有頁面或直接操作 `/api/*` 可能存在保護疏漏。
- XSS 風險：聊天室訊息、刊登描述、郵件模板渲染若使用不安全輸出（如未編碼）可能執行腳本。
- 資料一致性：`fix-chatroom-status.sql`, `fix-shipments.sql`, `fix-swaps-m5.sql` 顯示歷史資料需修補，暗示狀態機與事務一致性風險。
- 外部依賴：`etracking.py` 超時/錯誤碼未完善的重試與降級策略可能阻塞流程；SMTP/OAuth 失敗處理須驗證。
- 效能瓶頸：`/api/listings` 搜尋與排序可能缺索引或白名單限制，導致全表掃描；聊天高峰可能造成 DB 鎖競爭。

三、測試計畫與步驟（依測試類型）

安全性測試（Security）

- 測試案例與步驟：
  1) 未登入直接訪問內部頁（例：`/ui/profile`, `/ui/my-listings`, `/ui/proposals/mine`, `/ui/chat` 以及任何 `/admin`）：
	  - 步驟：以瀏覽器或 `MockMvc` 發送 GET；
	  - 預期：302 導向 `/ui/auth/login` 或 401/403；審計記錄登入要求；
	  - 關聯：安全 Filter/Controller 導向邏輯；模板條件 `th:if="${isLoggedIn}"`。
  2) API 未授權操作（例：`POST /api/proposals`、`POST /api/chat/{roomId}/messages`）：
	  - 步驟：不帶會話/Token 發送；
	  - 預期：401/403；不變更資料；
	  - 關聯：Controller 許可檢查、Service 權限驗證。
  3) XSS 注入檢測（聊天室訊息、刊登描述、Email 模板變數）：
	  - 步驟：輸入 `<script>alert(1)</script>`、事件處理器、SVG onload 等；
	  - 預期：輸出編碼，前端不執行腳本；郵件渲染拒絕不安全字串；
	  - 關聯：Thymeleaf `th:text` 使用、模板渲染器、安全輸出策略。
  4) SQL 注入與排序白名單檢測（`/api/listings`）：
	  - 步驟：於 `q`、`sort` 輸入惡意字串（例如 `OR 1=1`、未知欄位）；
	  - 預期：參數化查詢與欄位白名單阻擋；
	  - 關聯：Repository 查詢構建與參數綁定。

恢復測試（Recovery）

- 測試案例與步驟：
  1) 資料寫入時中斷 DB 連線：
	  - 步驟：在執行 `POST /api/proposals` 或 `POST /api/chat/{roomId}/messages` 寫入瞬間，模擬 DB 連線斷開（用測試容器或手動停 DB）。
	  - 預期：事務回滾，資料完整不污染；回應 5xx 並顯示友善錯誤頁/訊息；系統可在連線恢復後正常運作。
	  - 關聯：`@Transactional` 事務邊界、全域例外處理（`@ControllerAdvice`）。
  2) 外部服務中斷與恢復：
	  - 步驟：SMTP 拋出例外或回傳失敗、`etracking.py` 查詢超時、OAuth 回調失敗；
	  - 預期：重試策略生效、死信/告警記錄（若有）、不阻塞主流程；
	  - 關聯：郵件寄送器、`etracking` 查詢封裝、OAuth 客戶端錯誤處理。
  3) 系統重啟後狀態一致性：
	  - 步驟：於提案接受／配送設定後重啟服務；
	  - 預期：狀態機一致，無遺失；排程任務（若有）恢復正常；
	  - 關聯：資料持久層與服務層狀態初始化邏輯。

壓力測試（Stress）

- 測試案例與步驟：
  1) 大量使用者同時登入（1000 併發）：
	  - 步驟：以 JMeter/K6 對 `POST /api/auth/login` 發送併發請求；
	  - 預期：P95 響應時間在可接受範圍（≤1s~2s），無崩潰；錯誤率低於閾值；
	  - 關聯：認證服務、Session/Token 管理與資料庫連線池。
  2) 聊天高頻訊息：
	  - 步驟：對 `POST /api/chat/{roomId}/messages` 每秒高頻送出（例如 1000 QPS）；
	  - 預期：系統變慢但穩定；訊息排隊或節流策略生效；無記憶體洩漏；
	  - 關聯：聊天服務、資料庫寫入路徑、索引與鎖競爭。
  3) 批次郵件寄送：
	  - 步驟：批量觸發通知（例如每分鐘 500 封）；
	  - 預期：寄送速率符合設定；失敗重試與告警；
	  - 關聯：郵件佇列/重試策略。

效能測試（Performance）

- 測試案例與步驟：
  1) 首頁載入（TTFB/Load Time）：
	  - 步驟：以 Lighthouse/Playwright 測量 `/ui/home`；
	  - 預期：TTFB ≤ 500ms，整體載入 < 3 秒；資源壓縮與快取合理；
	  - 關聯：`home.html`、靜態資源、伺服器設定（`application.yml`）。
  2) 搜尋 SQL 回應時間：
	  - 步驟：對 `/api/listings` 在不同條件（關鍵字/分類/排序/分頁）測量；分析資料庫 Explain Plan；
	  - 預期：P95 < 2 秒；索引命中良好；無全表掃描；
	  - 關聯：Repository 查詢、資料庫索引設計、排序欄位白名單。

四、執行步驟與報告格式

- 測試執行清單（摘要）：
  - 建立測試環境與資料庫（參照 `application-test.yml`）。
  - 配置外部 Stub（SMTP/OAuth/物流）。
  - 依上節四類測試逐項執行，記錄：端點、輸入、狀態碼、UI 結果、DB 變更、Log/指標。

- 報告欄位格式（建議）：
  - 類型（Security/Recovery/Stress/Performance）
  - 端點/頁面（例：`/api/auth/login`、`/ui/home`）
  - 輸入（範例與資料集）
  - 預期（狀態碼/頁面/資料/指標）
  - 實際結果（含 P50/P95、錯誤率、GC/CPU/RAM）
  - 判定（Pass/Concern/Fail）

五、風險緩解建議（Based on Code Read）

- 強化授權與錯誤頁：確保未登入一律導向登入頁或回 401/403，配置一致的錯誤頁模板。
- 安全輸出策略：在所有使用者輸入顯示處堅持編碼輸出；郵件模板渲染加入變數白名單與必填檢查。
- 索引與查詢優化：對常用過濾/排序欄位建立索引；限制排序欄位白名單；審核 Repository 查詢避免 N+1。
- 外部故障退避：`etracking.py` 與 SMTP/OAuth 整合加入超時、退避重試與降級路徑；故障時不阻塞主流程。
- 事務一致性：在提案/聊天/出貨/送達流程層面明確事務邊界與狀態轉換原子性，避免再出現需修補的資料異常。

六、驗收門檻（標準）

- 安全性：未授權訪問均被拒或導向；XSS/SQLi 嘗試無效。
- 恢復力：DB/外部中斷不導致資料壞損；系統可恢復並持續服務。
- 壓力：在指定併發下無崩潰，錯誤率低於設定閾值；無明顯記憶體洩漏。
- 效能：首頁載入 < 3s；搜尋 P95 < 2s；主要端點 P95 在可接受範圍。

