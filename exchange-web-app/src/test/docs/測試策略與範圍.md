測試策略與範圍（Strategy & Scope）

更新日期：2025-12-12

總覽與測試風險評估

- 架構概述：本系統為 Java Spring MVC/Spring Boot 後端，前端以 JSP/Thymeleaf 模板與靜態資源為主，資料庫以關聯式 DB（見多份 SQL 修補與建立腳本），並含郵件通知與 Google OAuth 流程；另有 Python `utils/etracking/etracking.py` 用於物流追蹤。
- 主要模組：
 	- 使用者與身份驗證（含 OAuth）
 	- 刊登與搜尋（listing + filter）
 	- 交換流程（proposal/negotiation/chat/shipments/tracking/delivery）
 	- 通知（email）
- 風險重點：
	- 安全性：表單輸入與查詢參數的注入風險（SQL/模板/日誌）、權限邊界（交易房/聊天/評價）與越權存取（ID 參數操弄）。
	- 整合性：JSP 與 Controller 的資料綁定、國際化與編碼、表單驗證與後端校驗一致性；郵件與 OAuth 外部服務故障處理。
	- 效能：搜尋/過濾與列表頁可能產生 N+1 查詢或未加索引條件；批次通知併發、聊天訊息高峰期的 I/O 與資料庫鎖。
	- 穩健性：長鏈路業務（提案→協商→出貨→追蹤→送達→評價）跨多表多狀態，狀態機一致性與補償機制需測；修補腳本顯示歷史資料品質問題（fix-swaps/shipments/chatroom-status）。

測試策略總則

- 覆蓋面：針對核心業務邏輯與共用工具進行單元測試；重點整合路徑以 API+JSP 綁定為主的整合測試；系統層進行安全/效能/韌性；最後以 SRS 端到端場景做驗收。
- 測試資料：使用 `verify_database.sql` 與 `create-entities.ps1`/`DATABASE_SETUP.md` 所載結構建立最小可用數據，並以測試種子（fixtures）覆蓋主要場景。
- Mock/Stub 原則：
	- 外部依賴：郵件（SMTP/模板渲染）、OAuth（Google）、物流追蹤（HTTP）均以 Mock Server/Stub 取代，並補充故障/超時情境。
	- 時間與隨機：對涉及時間窗與 Token 的組件以可控 Clock/ID 產生器注入。
	- 資料層：對單元測試使用 Repository 的 Fake/In-memory；整合測試則使用測試資料庫（transaction rollback）。
- 覆蓋度度量：分支覆蓋（Branch Coverage）與條件覆蓋（Condition Coverage）≥ 80% 於核心服務；安全測試至少覆蓋 OWASP Top 10 高風險類項；主要端到端路徑全覆蓋（成功/失敗/異常）。

一、單元測試（Unit Testing）

範圍與重點

- 核心服務類與狀態機：
	- `ProposalService`：提案建立、驗證（所有權、重複提案）、狀態轉換（pending/accepted/rejected/expired）。
	- `NegotiationService` / `ChatService`：訊息驗證、房間狀態切換（見 fix-chatroom-status.sql 暗示邊界條件）、封禁/黑名單交互。
	- `ShipmentService` / `TrackingService`：貨態更新、事件序列一致性、重試策略（結合 `etracking.py` 模組結果）。
 	- `DeliveryService`：送達確認（雙方簽收）、糾紛觸發條件（SLA 超時）。
 	- （暫不納入）`ReviewService`：評價/聲譽相關功能未於本階段實作，故不列入單元測試範圍。
- 共用工具類（Utils）：
	- 驗證器（表單/參數）：Email、手機、地址、分頁參數、排序欄位白名單。
	- 轉換類（DTO ↔ Entity、日期/時區處理、金額與貨幣格式）。
	- Email 模板渲染器：佔位符完整性、國際化字串載入、XSS 安全輸出。
- 資料訪問層（Repository）與查詢語句：查詢條件組合、邊界值（空結果/大集合）、交易一致性。

Mock 對象（單元測試）

- `MailSender`/SMTP 客戶端、模板引擎（渲染結果以字串比較）。
- `OAuthClient`（Google）登入/Token 刷新結果（成功/失敗/超時/撤銷）。
- `EtrackingClient`（HTTP）：回傳不同運送狀態與錯誤碼。
- Repository/Fake DB（In-memory）：使用者、刊登、提案、聊天、貨運、評價。
- `Clock`/`IdGenerator`：控制時間窗與主鍵生成。

代表性測試案例（Unit）

- 提案建立：
	- 當使用者非刊登擁有者提出交換時，驗證不可與自身物品交換；預期：回傳錯誤 `ERR_SELF_SWAP_FORBIDDEN`。
	- 當重複對同一刊登提出提案時，驗證唯一性；預期：`ERR_DUPLICATE_PROPOSAL`。
- 協商/聊天：
	- 當聊天室被標記為 `closed`（修補腳本指示），新訊息不可送出；預期：HTTP 403 或業務錯誤碼。
	- 黑名單使用者無法加入協商；預期：拒絕並寫入審計日誌。
- 出貨/追蹤：
	- 當 `etracking` 回傳未知事件碼時，系統應記錄並標記為 `pending-review` 不中斷流程；預期：事件落庫、告警。
	- 當連續三次查詢超時，啟動退避（exponential backoff）；預期：呼叫間隔遞增且不超過上限。
- 送達確認：
	- 當 A 確認送達但 B 未確認，狀態保持 `awaiting-counterparty`；預期：不自動完成，定時提醒。
- 評價：
	- 當非交易雙方嘗試評價時拒絕；預期：`ERR_UNAUTHORIZED_REVIEW`。
- Utils：
	- 分頁參數：`page<0` 或 `size>max` 時矯正或拒絕；預期：400 錯誤或採用預設值。
	- Email 模板：缺少必填佔位符時拋出例外；預期：渲染失敗且不寄送。

覆蓋要求：對上述服務方法實現分支覆蓋≥80%，包含成功與失敗路徑、邊界值與例外拋出。

二、整合測試（Integration Testing）

範圍與重點

- 前端 JSP ↔ 後端 Controller：請求傳遞、模型屬性、表單驗證、國際化與編碼，確保資料綁定正確。
- REST/API：控制器端點、DTO 序列化、授權過濾器、全域例外處理（`@ControllerAdvice`）。
- DB 整合：事務邊界、查詢效能與索引命中（基本檢查），修補腳本對歷史資料之兼容性。
- 外部整合：SMTP、OAuth、物流追蹤以 Stub Server 模擬（成功/失敗/慢速）。

測試手法與環境

- 使用 `SpringBootTest` + `MockMvc` 驗證 Controller 與 JSP 模型：
	- GET 刊登列表：查詢參數綁定（`q`,`category`,`page`,`size`），模型包含 `items` 與分頁資訊；預期：模板渲染成功且元素數量符合。
	- POST 建立提案：表單綁定、JSR-303 驗證，失敗時回填錯誤訊息；預期：422/400 與錯誤提示顯示於 JSP。
- REST 端點（JSON）：
	- `POST /api/auth/login`：成功返回 Token；錯誤密碼返回 401；
	- `GET /api/listings`：過濾條件與排序白名單生效；非法欄位拒絕。
	- `POST /api/proposals`：建立提案並返回狀態；越權請求返回 403。
	- `POST /api/chat/{roomId}/messages`：房間封閉時返回 403。
	- `POST /api/shipment/{id}/update`：驗證狀態序列與重試標記。
- OAuth/Email/物流：
	- OAuth 登入流程以 Stub 驗證成功、授權拒絕、回調錯誤、Token 刷新；預期：對應的導向與錯誤頁面。
	- Email：模板渲染成功後送出；渲染失敗不送出並記錄；SMTP 失敗重試策略驗證。
	- 物流追蹤：Stub 回傳多種貨態與錯誤碼，系統對應狀態機更新或告警。
- DB 回滾：整合測試對資料變更以交易回滾（`@Transactional`），保持測試獨立性。

代表性測試案例（Integration）

- JSP 綁定：
	- 刊登搜尋頁：輸入 `q=phone`、`category=electronics` 與 `page=1,size=20`；預期：模型含正確分頁，模板顯示 20 筆，無 XSS 注入。
	- 提案表單：必填欄位遺漏時，於同頁顯示錯誤訊息並保留已填值。
- API：
	- 非擁有者對他人刊登提出提案成功；擁有者自提案被拒。
	- 已封閉聊天室發送訊息返回 403，審計紀錄包含使用者與房間 ID。
	- 出貨更新事件序列：`created→picked→in_transit→out_for_delivery→delivered`；任何逆序更新應拒絕並告警。

三、系統測試（非功能性）

安全性（Security）

- 注入攻擊：
	- SQL 注入：針對搜尋與過濾參數、ID 參數嘗試注入（例如 `OR 1=1`）；預期：參數化查詢與白名單阻擋，無資料外洩。
	- XSS：在評論、聊天訊息、郵件模板變數輸入 HTML/JS；預期：輸出編碼，模板不執行腳本。
	- CSRF：對表單端點驗證 CSRF Token；預期：缺 Token 請求被拒。
- 授權與越權：
	- 直接存取他人資源（修改提案、發送訊息、確認送達）；預期：403/404，審計日誌記錄。
	- 角色與權限矩陣測試（一般/管理員/封禁使用者）。
- 敏感資料處理：
	- 郵件與 OAuth 記錄不包含敏感 Token；設定檔不外洩凭證。

效能（Performance）

- 基準：
	- 刊登搜尋 API 在 P95 500ms 以內（1k 並發，適度快取/索引）。
	- 聊天訊息送出 P95 200ms 以內（500 並發）。
	- 批次郵件寄送每分鐘處理 ≥ 500 封（模板渲染與 SMTP 設限下）。
- 觀察：
	- SQL 查詢計劃與索引命中率（Explain/Analyze）；發現 N+1 或全表掃描時提出索引建議。
	- GC 與記憶體剖析（大列表、聊天高峰）。

恢復力與壓力測試（Resilience & Stress）

- 壓力與故障注入：
	- 物流追蹤服務 30% 超時、20% 錯誤碼；驗證退避與告警。
	- SMTP 連線間歇性失敗；驗證重試與死信佇列（若有）。
	- DB 故障（短暫不可用）；預期：請求降級與錯誤頁面友好提示。
- 極端輸入：
	- 搜尋 `q` 長度 0、1024、特殊字元；
	- 聊天訊息連續大量送出（每秒 1k）；預期：節流或排隊機制生效。
- 恢復驗證：
	- 系統恢復後，狀態機保持一致性（無重複事件、無錯誤跨越）。

四、驗收測試（Validation/Acceptance）

方法：以 SRS 與 `docs/use-cases` 的 UC-01~UC-08（目前已實作）覆蓋端到端流程。採用行為驅動 Given-When-Then，於測試環境以瀏覽器自動化（如 Selenium/WebDriver 或 Playwright）+ API 結合。

代表性端到端場景（E2E）

- UC-01 認證：
	- Given 使用者在登入頁；When 輸入有效帳密並登入；Then 導向首頁且顯示使用者名稱。
	- Given 使用者選擇 Google 登入；When OAuth 拒絕授權；Then 顯示錯誤提示並留在登入頁。
- UC-02 刊登建立：
	- Given 使用者已登入；When 填寫完整刊登表單並送出；Then 刊登建立且在列表可見。
- UC-03 搜尋與過濾：
	- Given 刊登存在；When 使用關鍵字與分類過濾；Then 列表顯示符合項且分頁正確。
- UC-04/05 提案與協商聊天：
	- Given A、B 兩方；When A 對 B 刊登提出提案並在聊天室協商；Then 狀態更新、訊息可見、禁止越權行為。
- UC-06/07/08 出貨、追蹤、送達確認：
	- Given 已接受提案；When A 建立出貨並更新貨態至送達；Then 雙方完成送達確認。


測試輸出與度量

- 報告：單元/整合/系統/驗收測試報告、覆蓋率報告、效能剖析、風險與建議。
- 缺陷管理：分類（安全/邏輯/效能/UX/資料）、嚴重度與優先級；關聯到 UC/SRS 條目。
- Gate：每個里程碑提供 PASS/CONCERNS/FAIL 建議與修復清單。

已識別的邏輯漏洞或異常風險（需驗證/修正）

- 聊天室狀態不一致：`fix-chatroom-status.sql` 暗示過去存在房間狀態錯置，需驗證服務層狀態轉換是否具原子性與事務保證。
- 出貨資料修補：`fix-shipments.sql` 與 `fix-swaps-m5.sql` 指向歷史資料品質問題，需加強資料驗證與遷移腳本前後一致性檢查。
- Email 模板與佔位符：`email-preview.html` 與升級說明顯示模板演進，需檢查渲染安全與必填變數缺失時的失敗處理。
- OAuth 回調錯誤處理：`GOOGLE_OAUTH_SETUP.md` 指示整合，需驗證拒絕授權/過期 Token/時區差異造成的有效期判斷。
- 物流追蹤外掛：`utils/etracking/etracking.py` 可能對外呼叫，需增加超時與錯誤碼對應映射；防止阻塞主流程。
- 索引與查詢：搜尋/過濾可能出現全表掃描或未白名單的排序欄位，需審查並壓力測試。

實施計畫與下一步

- 立即事項：
	- 建立測試資料庫與測試配置（`application-test.yml` 參照現有 `target/test-classes/application-test.yml`）。
	- 為核心服務撰寫單元測試骨架與 Mock 介面；設定 `@Transactional` 整合測試基底。
	- 準備 Stub 服務：SMTP、OAuth、物流追蹤。
-- 中期事項：
 	- 效能剖析與索引優化建議；壓力與故障注入腳本。
 	- E2E 測試腳本覆蓋 UC-01~UC-08，與 SRS 形成 Traceability。
- 驗收 Gate：集成報告與風險清單，提出 PASS/CONCERNS/FAIL 建議。
