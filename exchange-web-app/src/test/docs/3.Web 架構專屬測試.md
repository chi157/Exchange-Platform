Web 架構與結構完整性測試（Web Architecture Testing）

更新日期：2025-12-12

總覽

- 架構背景：前端以 Thymeleaf/JSP 模板（如 `templates/home.html`）與靜態資源為主；後端採 Spring MVC/Boot Controller 提供 `/ui/*` 導覽與 `/api/*` 端點；登入狀態以 Session/安全過濾維持，頁面資料透過 Model 綁定。
- 目標：以靜態結構分析與覆蓋率指標，確保網站導覽正確、連結無誤、狀態資料在頁面間傳遞正確無遺漏。

一、靜態結構測試（Static Analysis）

檢測項目與機制

- 孤兒頁面（Orphan Pages）檢測：
	- 掃描 `src/main/resources/templates/` 內所有 `.html` 模板檔；建立頁面清單（P）。
	- 以 HTML 解析器（如 jsoup）抽取所有超連結 `a[href]`、表單 `form[action]`、前端導覽（`href="/ui/*"`）形成導向邊集合（E）。
	- 另以伺服器端路由（Controller 映射）比對可達 URL 集合（R）。
	- 孤兒頁面定義：屬於 P，但不被任何 E 指向且無對應 R 入口；列入風險清單。
- 幽靈頁面/失效連結（Ghost Pages / Broken Links）檢測：
	- 建置輕量爬蟲：從首頁 `/ui/home` 出發，廣度優先爬取所有站內連結（限制網域與路徑前綴 `/ui`、`/api`）。
	- 對每個 URL 執行 HTTP 請求（GET/POST 依方法，對 POST 改用 `HEAD`/GET 連通性檢查），記錄狀態碼。
	- 失效連結定義：返回 `404/410/5xx` 或重定向至錯誤頁；標註來源頁、來源元素選擇器、目標 URL 與狀態。
- 自動化執行方式：
	- 方案 A（Java 測試）：以 `MockMvc` + jsoup 結合，對已知模板解析連結，再以整合測試請求驗證狀態碼。
	- 方案 B（Playwright/Selenium）：瀏覽器自動化遍歷所有導覽元素與錨點，攔截網路請求並收集狀態碼與錯誤。
	- 方案 C（Python 腳本）：使用 `requests` + `BeautifulSoup` 建立站點圖，輸出報告（CI 友善）。

連結有效性報告格式（建議）

| 來源頁面 | 元素描述/選擇器 | 目標 URL | 方法 | 狀態碼 | 結果 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| /ui/home | a.btn-back | /ui/listings | GET | 200 | 有效 |
| /ui/home | a[href="/ui/profile"] | /ui/profile | GET | 302→/ui/auth/login | 需登入（有效） |
| /ui/listings | a.item-link | /ui/proposals/new?id=123 | GET | 404 | 失效（需修正） |

二、測試覆蓋率指標（Coverage Criteria）

覆蓋定義

1) 頁面覆蓋率（Page Coverage）：
- 定義：測試執行中至少載入並驗證每一張模板頁（含條件渲染）。
- 達成條件：對每個 `templates/*.html` 有一條測試紀錄（成功載入/渲染且主要模型變數存在）。

2) 連結覆蓋率（Link Coverage）：
- 定義：站內所有 `a[href]`、按鈕（帶 `href` 或 `form[action]`）與導覽控制至少被觸發一次並驗證導向結果。
- 達成條件：每個連結元素在報告中有一筆成功驗證（200/302 且目標頁正確），或標示需登入/權限保護但路徑有效。

3) 定義-使用覆蓋率（Define-Use Coverage）：
- 定義：針對 Session/Request/Model 的狀態變數，驗證其定義（set）與使用（get）路徑完整。
- 達成條件：主要流程（登入→提案→出貨→追蹤→送達）中，每個關鍵變數均有至少一條測試路徑覆蓋定義點與使用點（含越權/無效狀態）。

覆蓋率追蹤表（模板）

| 類別 | 標的 | 覆蓋目標 | 目前比率 | 狀態 |
| :--- | :--- | :--- | :--- | :--- |
| Page | templates/home.html 等 | 100% 頁面載入驗證 | 0% | 待執行 |
| Link | 所有 `a[href]`/`form[action]` | 100% 連結觸發驗證 | 0% | 待執行 |
| Define-Use | `currentUserDisplayName` 等 | 100% 主要變數路徑覆蓋 | 0% | 待執行 |

三、資料流分析（Define-Use 路徑示例）

複雜流程：提案→協商聊天→配送設定→物流追蹤→送達確認

- 變數清單與生命週期：
	- `session.user`（登入後設定於 Session）：
		- 定義（Define）：登入成功後於 Auth Controller 設定。
		- 使用（Use）：
			- 在 `/ui/my-listings`、`/ui/proposals/mine` 等頁面讀取以過濾使用者資料。
			- 在 API 層驗證提案/聊天/出貨操作權限。
	- `model.currentUserDisplayName`（頁面模型變數）：
		- 定義：Controller 渲染 `home.html` 時注入。
		- 使用：首頁右上角使用者顯示區塊（顯示名稱）。
	- `request.proposalId`（請求參數）：
		- 定義：從提案列表或詳情頁按鈕帶入。
		- 使用：在 Proposal Controller 載入提案，進入聊天室房間。
	- `shipment.trackingCode`（模型/資料庫欄位）：
		- 定義：配送設定頁輸入交貨便代碼。
		- 使用：在 Tracking Service 查詢物流並更新事件序列。
	- `delivery.confirmationStatus`（資料庫狀態）：
		- 定義：任一方確認送達後寫入。
		- 使用：在 UI 顯示完成標記；雙方皆確認時觸發完成流程。

Define-Use 測試路徑（示例）

| 路徑 ID | Given/When/Then | 驗證點 |
| :--- | :--- | :--- |
| DU-01 | Given 使用者成功登入（Define: `session.user`）；When 造訪 `/ui/home` 與 `/ui/my-listings`；Then 顯示使用者名稱與只展示自己的刊登 | Session 定義→UI 使用、一致性 |
| DU-02 | Given 從提案列表點擊進入詳情（Define: `request.proposalId`）；When 進入聊天室；Then 成功載入對應房間、拒絕非參與者 | Request 變數傳遞與權限 |
| DU-03 | Given 設定交貨便代碼（Define: `shipment.trackingCode`）；When 觸發追蹤；Then 事件序列依序更新、未知事件記告警 | 模型→服務→DB 使用 |
| DU-04 | Given A 確認送達（Define: `delivery.confirmationStatus=A_confirmed`）；When B 仍未確認；Then UI 顯示等待對方、狀態不完成 | 單方確認邏輯 |
| DU-05 | Given 雙方皆確認（Define: `delivery.confirmationStatus=completed`）；When 返回交易列表；Then 顯示完成標記、不可再操作 | 完成條件驗證 |

四、潛在結構性風險點（目錄導覽分析）

- 導覽一致性：首頁 `home.html` 導覽列包含多連結（我的刊登/提案管理/交換/聊天室/個人資料），需確保每個路徑在未登入時導向登入頁，登入後可達；任何新增模板須納入導覽或站點地圖。
- 錨點與內部段落：頁面內 `#tutorial`、`#qna` 之錨點需檢查滾動與位置正確；避免重構導致失效。
- 錯誤頁與重定向：確保 404/403/500 錯誤頁存在並在爬蟲中被識別為預期結果；避免錯誤重定向循環。
- 外部依賴：OAuth 回調、SMTP 錯誤、物流 API 超時時，前端顯示與導向需具體明確；避免使用者卡在半成品路徑。
- 模板條件渲染：`th:if="${isLoggedIn}"` 等條件需在測試中覆蓋兩種分支以達到頁面與連結的完整覆蓋率。

五、執行細節與建議工具

- 工具組合：
	- 單元/整合（Java）：`SpringBootTest` + `MockMvc` + jsoup 解析模板抽取連結，進行狀態檢查。
	- 瀏覽器自動化：Playwright（Node/Java）或 Selenium（Java）以 Data-Driven 方式遍歷所有 `a[href]`/`button`，紀錄導向與狀態。
	- Python 快速檢查：`requests` + `BeautifulSoup` 生成站點圖與失效連結報告（CI/CD 方便）。
- CI 建議：在 PR/合併前執行連結健康檢查，輸出 CSV/HTML 報告並設定閾值（失效連結數量上限）。

六、覆蓋率目標（里程碑）

- 頁面覆蓋率：≥ 95%（含條件渲染頁）。
- 連結覆蓋率：≥ 95%（含需登入的連結標示為「有效需登入」）。
- Define-Use 覆蓋率：主要交易流程變數 100%（登入→提案→出貨→追蹤→送達）。

